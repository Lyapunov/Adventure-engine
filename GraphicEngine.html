<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>

   </head>
   <body>
      <div id="blueprints" style="visibility:hidden; display:none">
[
[{"obj_content": {"attributes": [],
                  "childObjects": [{"obj_content": {"attributes": ["immobile"], "childObjects": [], "name": "table"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "candle"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "match"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "bird"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "stone"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": ["immobile", "invisible"], "childObjects": [], "name": "picture"}, "obj_name": "GameObject"}],
                  "name": "dark room"},
  "obj_name": "GameObject"},
 {"obj_content": {"attributes": [],
                  "childObjects": [{"obj_content": {"attributes": ["immobile"],
                                                    "childObjects": [{"obj_content": {"attributes": [], "childObjects": [], "name": "knife"}, "obj_name": "GameObject"}],
                                                    "name": "cabinet"},
                                    "obj_name": "GameObject"}],
                  "name": "bathroom"},
  "obj_name": "GameObject"},
 {"obj_content": {"attributes": [],
                  "childObjects": [],
                  "name": "secret room"},
  "obj_name": "GameObject"}],
[{"obj_content": {"attributes": [],
                  "childObjects": [],
                  "name": "burning candle"},
  "obj_name": "GameObject"},
 {"obj_content": {"attributes": [],
                  "childObjects": [],
                  "name": "injured bird"},
  "obj_name": "GameObject"}],
[{"obj_content": {"room_name2": "bathroom", "room_name1": "dark room", "direction2": "S", "attributes": [], "direction1": "N", "identifier": 11},
  "obj_name": "GamePassage"},
 {"obj_content": {"room_name2": "secret room", "room_name1": "dark room", "direction2": "E", "attributes": ["invisible"], "direction1": "W", "identifier": 12},
  "obj_name": "GamePassage"}],
[{"obj_content": {"subjectname": "candle", "toolname": "match", "resultname": "burning candle"},
  "obj_name": "GameObjectUseAction"},
 {"obj_content": {"subjectname": "bird", "toolname": "stone", "resultname": "injured bird"},
  "obj_name": "GameObjectUseAction"},
 {"obj_content": {"subjectname": "picture", "toolname": "", "identifier": 12},
  "obj_name": "GamePassageRevealAction"}],
[{"obj_content": {"subjectname": "picture", "toolname": "burning candle"},
  "obj_name": "GameObjectRevealAction"}],
"secret room",
{"go#dark room": "You find yourself in a very dark room. You barelly recognize even the edges of the walls without an external light source. You have no memories about how you did get there. There can be something like a trap door on the ceiling, but it is concealed in the darkness. After taking careful steps and touching throgh the object, you find a passage to another room.", "go#bathroom": "bathroom", "go#secret room": "Congratulations. You found an exit, and you won the game." }
]
      </div>

   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var blueprints = JSON.parse( document.getElementById('blueprints').innerText );
         // console.log('blueprints: ', blueprints);

         // weird, but adding functions to the blueprints recursively - doing the same things that in Python
         function addFunctionsToObjectsRecursively( input ) {
            if ( input instanceof Array ) {
               for ( var i = 0; i < input.length; ++i ) {
                  addFunctionsToObjectsRecursively( input[i] );
               }
               return;
            }
            if ( null == input.obj_content ) {
               return;
            }
            if ( null != input.obj_content.childObjects ) {
               addFunctionsToObjectsRecursively( input.obj_content.childObjects );
            }
            if ( null != input.obj_name ) {
               console.log( "--->" + input.obj_name );
            }

            // Adding functions to object
            switch ( input.obj_name ) {
               case "GameObject" :  
                  input.get_hash_name = function() {
                     return "go#" + input.obj_content.name;
                  }
                  input.is_visible = function() { 
                     return input.obj_content.attributes.indexOf( "invisible" ) == -1;
                  };
                  input.make_visible = function() {
                     var index = input.obj_content.attributes.indexOf( "invisible" );
                     input.obj_content.splice( index, 1 );
                  };
                  input.get_attributes = function() {
                     return input.obj_content.attributes;
                  };
                  input.find = function( name ) {
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( input.obj_content.childObjects[i].obj_content.name == name ) {
                           return input.obj_content.childObjects[i];
                        }
                     }
                     return null;
                  };
                  input.children = function() {
                     return input.obj_content.childObjects;
                  };
                  input.takable_child_names = function() {
                     var retval = [];
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'immobile' ) < 0
                             && input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'invisible' ) < 0 ) {
                           retval.push( input.obj_content.childObjects[i].obj_content.name );
                        }
                     }
                     return retval;
                  };
                  input.openable_child_names = function() {
                     var retval = [];
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( input.obj_content.childObjects[i].obj_content.childObjects.length > 0 ) {
                           retval.push( input.obj_content.childObjects[i].obj_content.name );
                        }
                     }
                     return retval;
                  };
                  input.descendants = function( add_top_children ) {
                     if ( typeof(add_top_children) === 'undefined' ) {
                        add_top_children = 1
                     }
                     var retval = [];
                     if ( add_top_children ) {
                        retval = retval.concat( input.children() );
                     }
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        retval = retval.concat( input.obj_content.childObjects[i].children() );
                     }
                     return retval;
                  };
                  input.take = function( name ) {
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( name == input.obj_content.childObjects[i].obj_content.name 
                             && input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'immobile' ) < 0
                             && input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'invisible' ) < 0 ) {
                           retval = input.obj_content.childObjects[i];
                           input.obj_content.childObjects.splice( i, 1 );
                           return retval;
                        }
                     }
                     return null;
                  };
                  input.put = function( obj ) {
                     if ( obj != null ) {
                        input.obj_content.childObjects.push( obj );
                     }
                  };
                  break;
               case "GamePassage" :  
                  input.get_ordered_name = function() {
                     if ( input.obj_content.room_name1 < input.obj_content.room_name2 ) {
                        return [ input.obj_content.room_name1, input.obj_content.room_name2 ];
                     } else {
                        return [ input.obj_content.room_name2, input.obj_content.room_name1 ];
                     }
                  };
                  input.make_visible = function () {
                     var pos = input.obj_content.attributes.indexOf( 'invisible' );
                     if ( pos >= 0 ) {
                        input.obj_content.attributes( 'invisible', 1 );
                     }
                  };
                  input.get_out_passage_from_room = function( roomname, visibility ) {
                     if ( typeof(visibility) === 'undefined' ) {
                        visibility = 1
                     }
                     if ( visibility
                          && 0 <= input.obj_content.attributes.indexOf( 'invisible' ) ) {
                        return null;
                     }
                     if ( roomname == input.obj_content.room_name1 ) {
                        return [ input.obj_content.direction1,  input.obj_content.room_name2 ];
                     }
                     if ( roomname == input.obj_content.room_name2 ) {
                        return [ input.obj_content.direction2,  input.obj_content.room_name1 ];
                     }
                     return null;
                  };
                  break;
               case "GameObjectUseAction" :  
                  input.subject_to_reveal = function() {
                     return [];
                  };
                  input.get_actor_names = function() {
                     if ( input.obj_content.subjectname < input.obj_content.toolname ) {
                        return [ input.obj_content.subjectname, input.obj_content.toolname ];
                     }
                     return [ input.obj_content.toolname, input.obj_content.subjectname ];
                  };
                  input.applicable = function( subjectname, toolname ) {
                     return input.obj_content.subjectname == subjectname 
                            && input.obj_content.toolname == toolname;
                  };
                  input.perform = function( game ) {
                     game.move_between_entities( input.obj_content.toolname, game.inventory, null );
                     pair = game.find( input.obj_content.subjectname );
                     subject = pair[0];
                     entity  = pair[1];
                     if ( subject != null ) {
                        entity.take( subject.obj_content.name );
                        retval = game.find_in_limbo_and_remove( input.obj_content.resultname );
                        entity.put( retval );
                        return retval;
                     }
                     return null;
                  };
                  input.showIt = function( game ) {
                     game.views.remove( input );
                     return input.perform( game );
                  };
                  input.doIt = function( game ) {
                     game.use_actions.remove( input );
                     return input.perform( game );
                  };
                  break;
               case "GamePassageRevealAction" :  
                  input.subject_to_reveal = function() {
                     return [ '@#passage#@'];
                  };
                  input.get_actor_names = function() {
                     if ( input.obj_content.subjectname < input.obj_content.toolname ) {
                        return [ input.obj_content.subjectname, input.obj_content.toolname ];
                     }
                     return [ input.obj_content.toolname, input.obj_content.subjectname ];
                  };
                  input.get_passage_identifier = function () {
                     return input.obj_content.identifier;
                  };
                  input.applicable = function( subjectname, toolname ) {
                     return input.obj_content.subjectname == subjectname 
                            && input.obj_content.toolname == toolname;
                  };
                  input.doIt = function( game ) {
                     for( var i = 0; i < game.passages.length; ++i ) {
                        if ( game.passages[i].identifier == input.obj_content.identifier ) {
                           game.passages[i].make_visible();
                        }
                     }
                  };
                  break;
               case "GameObjectRevealAction" :
                  input.subject_to_reveal = function() {
                     return [ input.obj_content.subjectname ];
                  };
                  input.get_actor_names = function() {
                     if ( input.obj_content.subjectname < input.obj_content.toolname ) {
                        return [ input.obj_content.subjectname, input.obj_content.toolname ];
                     }
                     return [ input.obj_content.toolname, input.obj_content.subjectname ];
                  };
                  input.get_passage_identifier = function () {
                     return input.obj_content.identifier;
                  };
                  input.applicable = function( subjectname, toolname ) {
                     return input.obj_content.subjectname == subjectname 
                            && input.obj_content.toolname == toolname;
                  };
                  input.showIt = function( game ) {
                     game.views.remove( input );
                     var pair2   = game.find( input.obj_content.toolname );
                     var tool    = pair2[0];
                     var pair1   = game.find( input.obj_content.subjectname );
                     var subject = pair1[0];
                     if ( tool != null && subject != null && !subject.is_visible() ) {
                        subject.make_visible();
                        return subject;
                     }
                     return null;
                  };
                  break;
            }
         }

         function GameInternal( params ) {
            this.rooms = params[0]; 
            this.limbo = params[1]; 
            this.room  = null;
            if ( this.rooms.length > 0 ) {
               this.room = this.rooms[0];
            }
            this.passages     = params[2];
            this.inventory    = { obj_content : { attributes: [], childObjects: [], name: "inventory"}, obj_name: "GameObject" }
            addFunctionsToObjectsRecursively( this.inventory );
            this.use_actions  = params[3];
            this.views        = params[4];
            this.won_         = 0;
            this.final_room   = params[5];
            this.descriptions = params[6];
            this.current_room = function () {
               return this.room.obj_content.name;
            };
            this.find_in_limbo_and_remove = function( name ) {
               var retval = null;
               var place = 0;
               for ( var i = 0; i < this.limbo.length; ++i ) {
                  if ( this.limbo[i].obj_content.name == name ) {
                     retval = this.limbo[i].obj_content;
                     place  = i;
                     break;
                  }
               }
               if ( retval != null ) {
                  this.limbo.splice( place, 1 );
               }
               return retval;
            };
            this.find_room = function( name ) {
               for ( var i = 0; i < this.rooms.length; ++i ) {
                  if ( this.rooms[i].obj_content.name == name ) {
                     return this.rooms[i];
                  }
               }
               return null;
            };
            this.winning = function() {
               this.won = 1;
            };
            this.setting_current_room = function( name ) {
               var retval = this.find_room( name );
               if ( retval != null ) {
                  this.room = retval;
                  if ( name == this.final_room ) {
                     this.winning();
                  }
               }
            };
            this.won = function () {
               return this.won_;
            };
            this.move_between_entities = function( name, from_entity, to_entity ) {
               var subject = from_entity.take( name );
               if ( subject != null ) {
                  to_entity.put( name );
                  return subject;
               }
               return null;
            };
            this.view_refresh = function () {
               var sorrounding_objects = [];
               sorrounding_objects.concat( this.inventory.obj_content.childObjects );
               sorrounding_objects.concat( this.room.obj_content.childObjects );
               for ( var i = 0; i < this.views.length; ++i ) {
                  var action = this.views[i];
                  var pair1  = this.find( action.obj_content.subjectname );
                  var pair2  = this.find( action.obj_content.toolname );
                  if ( pair1[0] != null && pair2[0] != null && action.applicable( pair1[0], pair2[0] ) ) {
                     action.showIt( this );
                  }
               }
            };
            this.find_in_entities = function ( name, entities ) {
               for ( var i = 0; i < entities.length; ++i ) {
                  var attempt = entities[i].find( name );
                  if ( attempt != null ) {
                     return [ attempt, entities[i] ];
                  }
               }
               return [null, null];
            };
            this.find_room = function ( name ) {
               for ( var i = 0; i < this.rooms.length; ++i ) {
                  if ( this.rooms[i].obj_content.name == name ) {
                     return this.rooms[i];
                  }
               }
               return null;
            };
            this.open = function ( name, other ) {
               if ( other != null ) {
                  return 0;
               }
               var pair = this.find( name );
               if ( pair[0] == null ) {
                  return 0;
               }
               while ( pair[0].children().lenght > 0 ) {
                  pair[1].put(pair[0].take( pair[0].children()[0].obj_content.name ) );
               }
               return 1;
            };
            this.use_internal = function( subjectname, toolname ) {
               if ( subjectname == '' ) {
                  return null;
               }
               var pair1 = this.find( subjectname );
               if ( pair1[0] == null ) {
                  return null;
               }
               if ( toolname == '' ) {
                  for ( var i = 0; i < this.use_actions.length; ++i ) {
                     var action = this.use_actions[i];
                     if ( action.applicable( pair1[0].obj_content.name, '' ) ) {
                        return action.doIt( this );
                     }
                  }
                  return null;
               } else {
                  var pair2 = this.find( toolname );
                  if ( pair2[0] == null ) {
                     return null;
                  }
                  for ( var i = 0; i < this.use_actions.length; ++i ) {
                     var action = this.use_actions[i];
                     if ( action.applicable( pair1[0].obj_content.name, pair2[0].obj_content.name ) ) {
                        return action.doIt( this );
                     }
                  }
                  return null;
               }
            };
            this.take = function( name, other ) {
               if ( other != null ) {
                  return 0;
               }
               return input.move_between_entities( name, this.room, this.inventory );
            };
            this.drop = function( name, other ) {
               if ( other != null ) {
                  return 0;
               }
               return input.move_between_entities( name, this.inventory, this.room );
            };
            this.has = function( name ) {
               var subject = this.inventory.find( name );
               return subject;
            };
            this.look = function() {
               var desc = this.descriptions[this.room.get_hash_name()];
               if ( desc == undefined ) {
                  return '';
               } else {
                  return desc;
               }
            };
            this.find = function( name ) {
               return this.find_in_entities( name, [ this.inventory, this.room ] );
            }
         }

         addFunctionsToObjectsRecursively( blueprints );

         var game = new GameInternal( blueprints );

         // Smoke tests:
         // ------------

         // GameObject:
         // console.log( blueprints[0][0].find( 'bird' ) );
         // console.log( blueprints[0][0].takable_child_names() );
         // console.log( blueprints[0][0].openable_child_names() );
         // console.log( blueprints[0][0].children() );
         // console.log( blueprints[0][0].descendants( true ) );

         // console.log( blueprints[0][0].takable_child_names() );
         // var mybird = blueprints[0][0].take( 'bird' );
         // console.log( blueprints[0][0].takable_child_names() );
         // blueprints[0][0].put( mybird );
         // console.log( blueprints[0][0].takable_child_names() );

         // GamePassage:
         // console.log( blueprints[2][0].get_ordered_name() );
         // console.log( blueprints[2][1].get_ordered_name() );
         // console.log( blueprints[2][0].get_out_passage_from_room('dark room') );
         // console.log( blueprints[2][1].get_out_passage_from_room('dark room') );
         // console.log( blueprints[2][1].get_out_passage_from_room('dark room',0) );

         // console.log( game.current_room() );
         // console.log( game.find_in_limbo_and_remove('burning candle') );
         // console.log( game.find_in_limbo_and_remove('turbo killer') );
         // console.log( game.find_room('dark room') );
         // console.log( game.find_room('purple room') );

         // console.log( game.current_room() );
         // game.setting_current_room('bathroom');
         // console.log( game.current_room() );

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
         })();
      </script>
   </body>
</html>
