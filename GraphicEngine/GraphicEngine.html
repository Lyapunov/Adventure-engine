<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
            cursor : none;
         }
      </style>

   </head>
   <body bgcolor="000000">
      <div id="blueprints" style="visibility:hidden; display:none">
[
[{"obj_content": {"attributes": [],
                  "childObjects": [{"obj_content": {"attributes": ["immobile"], "childObjects": [], "name": "table"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "candle"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "match"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "bird"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": [], "childObjects": [], "name": "stone"}, "obj_name": "GameObject"},
                                   {"obj_content": {"attributes": ["immobile", "invisible"], "childObjects": [], "name": "picture"}, "obj_name": "GameObject"}],
                  "name": "dark_room"},
  "obj_name": "GameObject"},
 {"obj_content": {"attributes": [],
                  "childObjects": [{"obj_content": {"attributes": ["immobile"],
                                                    "childObjects": [{"obj_content": {"attributes": [], "childObjects": [], "name": "knife"}, "obj_name": "GameObject"}],
                                                    "name": "cabinet"},
                                    "obj_name": "GameObject"}],
                  "name": "bathroom"},
  "obj_name": "GameObject"},
 {"obj_content": {"attributes": [],
                  "childObjects": [],
                  "name": "secret_room"},
  "obj_name": "GameObject"}],
[{"obj_content": {"attributes": [],
                  "childObjects": [],
                  "name": "burning_candle"},
  "obj_name": "GameObject"},
 {"obj_content": {"attributes": [],
                  "childObjects": [],
                  "name": "injured_bird"},
  "obj_name": "GameObject"}],
[{"obj_content": {"room_name2": "bathroom", "room_name1": "dark_room", "direction2": "S", "attributes": [], "direction1": "N", "identifier": 11},
  "obj_name": "GamePassage"},
 {"obj_content": {"room_name2": "secret_room", "room_name1": "dark_room", "direction2": "E", "attributes": ["invisible"], "direction1": "W", "identifier": 12},
  "obj_name": "GamePassage"}],
[{"obj_content": {"subjectname": "candle", "toolname": "match", "resultname": "burning_candle"},
  "obj_name": "GameObjectUseAction"},
 {"obj_content": {"subjectname": "bird", "toolname": "stone", "resultname": "injured_bird"},
  "obj_name": "GameObjectUseAction"},
 {"obj_content": {"subjectname": "picture", "toolname": "knife", "identifier": 12},
  "obj_name": "GamePassageRevealAction"}],
[{"obj_content": {"subjectname": "picture", "toolname": "burning_candle"},
  "obj_name": "GameObjectRevealAction"}],
"secret_room",
{"go#dark_room": "You find yourself in a very dark_room. You barelly recognize even the edges of the walls without an external light source. You have no memories about how you did get there. There can be something like a trap door on the ceiling, but it is concealed in the darkness. After taking careful steps and touching throgh the object, you find a passage to another room.", "go#bathroom": "bathroom", "go#secret_room": "Congratulations. You found an exit, and you won the game." }
]
      </div>

   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var devMode = 1;

         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var gameScreenWidth  = 640;
         var gameScreenHeight = 480;
         var gameScreenSeparatorY = 400;

         var dirImgs = "imgs/";

         // static size
         mainItem.width  = gameScreenWidth; 
         mainItem.height = gameScreenHeight;


         var cursorWidth  = 20;
         var cursorHeight = 30;

         var fps = 25;
         var ANIMATION;
         var redrawArea = null;

         var game_object_pictures = {};
         var images = new Object();
         images['cursor'] = new Image();
         images['cursor'].src = dirImgs + "cursor.png";
         images['menuitem_button1'] = new Image();
         images['menuitem_button1'].src = dirImgs + "menuitem_button1.png";
         images['menuitem_button2'] = new Image();
         images['menuitem_button2'].src = dirImgs + "menuitem_button2.png";
         images['menuitem_screen1'] = new Image();
         images['menuitem_screen1'].src = dirImgs + "menuitem_screen1.png";
         images['menuitem_screen2'] = new Image();
         images['menuitem_screen2'].src = dirImgs + "menuitem_screen2.png";

         // weird, but adding functions to the blueprints recursively - doing the same things that in Python
         function addFunctionsToObjectsRecursively( input ) {
            if ( input instanceof Array ) {
               for ( var i = 0; i < input.length; ++i ) {
                  addFunctionsToObjectsRecursively( input[i] );
               }
               return;
            }
            if ( null == input.obj_content ) {
               return;
            }
            if ( null != input.obj_content.childObjects ) {
               addFunctionsToObjectsRecursively( input.obj_content.childObjects );
            }
            if ( null != input.obj_name ) {
               if ( input.obj_name == "GameObject" ) {
                  if ( input.obj_content.name != "inventory" ) {
                     game_object_pictures[ input.obj_content.name ] = input.obj_content.name + ".png";
                     images[ input.obj_content.name ] = new Image();
                     images[ input.obj_content.name ].src = dirImgs + input.obj_content.name + ".png";
                  }
               }
               if ( input.obj_name == "GamePassage" ) {
                  var name1 = input.obj_content.room_name1 + '_' + input.obj_content.direction1;
                  var name2 = input.obj_content.room_name2 + '_' + input.obj_content.direction2;
                  images[ name1 ] = new Image();
                  images[ name1 ].src = dirImgs + name1 + ".png";
                  images[ name2 ] = new Image();
                  images[ name2 ].src = dirImgs + name2 + ".png";
               }
            }

            // Adding functions to object
            switch ( input.obj_name ) {
               case "GameObject" :  
                  input.get_hash_name = function() {
                     return "go#" + input.obj_content.name;
                  }
                  input.is_visible = function() { 
                     return input.obj_content.attributes.indexOf( "invisible" ) == -1;
                  };
                  input.make_visible = function() {
                     var index = input.obj_content.attributes.indexOf( "invisible" );
                     if ( index >= 0 ) {
                        input.obj_content.attributes.splice( index, 1 );
                     }
                  };
                  input.get_attributes = function() {
                     return input.obj_content.attributes;
                  };
                  input.find = function( name ) {
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( input.obj_content.childObjects[i].obj_content.name == name ) {
                           return input.obj_content.childObjects[i];
                        }
                     }
                     return null;
                  };
                  input.children = function() {
                     return input.obj_content.childObjects;
                  };
                  input.takable_child_names = function() {
                     var retval = [];
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'immobile' ) < 0
                             && input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'invisible' ) < 0 ) {
                           retval.push( input.obj_content.childObjects[i].obj_content.name );
                        }
                     }
                     return retval;
                  };
                  input.openable_child_names = function() {
                     var retval = [];
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( input.obj_content.childObjects[i].obj_content.childObjects.length > 0 ) {
                           retval.push( input.obj_content.childObjects[i].obj_content.name );
                        }
                     }
                     return retval;
                  };
                  input.descendants = function( add_top_children ) {
                     if ( typeof(add_top_children) === 'undefined' ) {
                        add_top_children = 1
                     }
                     var retval = [];
                     if ( add_top_children ) {
                        retval = retval.concat( input.children() );
                     }
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        retval = retval.concat( input.obj_content.childObjects[i].children() );
                     }
                     return retval;
                  };
                  input.take = function( name ) {
                     for ( var i = 0; i < input.obj_content.childObjects.length; ++i ) {
                        if ( name == input.obj_content.childObjects[i].obj_content.name 
                             && input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'immobile' ) < 0
                             && input.obj_content.childObjects[i].obj_content.attributes.indexOf( 'invisible' ) < 0 ) {
                           retval = input.obj_content.childObjects[i];
                           input.obj_content.childObjects.splice( i, 1 );
                           return retval;
                        }
                     }
                     return null;
                  };
                  input.put = function( obj ) {
                     if ( obj != null ) {
                        input.obj_content.childObjects.push( obj );
                     }
                  };
                  break;
               case "GamePassage" :  
                  input.get_ordered_name = function() {
                     if ( input.obj_content.room_name1 < input.obj_content.room_name2 ) {
                        return [ input.obj_content.room_name1, input.obj_content.room_name2 ];
                     } else {
                        return [ input.obj_content.room_name2, input.obj_content.room_name1 ];
                     }
                  };
                  input.make_visible = function () {
                     var pos = input.obj_content.attributes.indexOf( 'invisible' );
                     if ( pos >= 0 ) {
                        input.obj_content.attributes.splice( 'invisible', 1 );
                     }
                  };
                  input.get_out_passage_from_room = function( roomname, visibility ) {
                     if ( typeof(visibility) === 'undefined' ) {
                        visibility = 1
                     }
                     if ( visibility
                          && 0 <= input.obj_content.attributes.indexOf( 'invisible' ) ) {
                        return null;
                     }
                     if ( roomname == input.obj_content.room_name1 ) {
                        return [ input.obj_content.direction1,  input.obj_content.room_name2 ];
                     }
                     if ( roomname == input.obj_content.room_name2 ) {
                        return [ input.obj_content.direction2,  input.obj_content.room_name1 ];
                     }
                     return null;
                  };
                  break;
               case "GameObjectUseAction" :  
                  input.subject_to_reveal = function() {
                     return [];
                  };
                  input.get_actor_names = function() {
                     if ( input.obj_content.subjectname < input.obj_content.toolname ) {
                        return [ input.obj_content.subjectname, input.obj_content.toolname ];
                     }
                     return [ input.obj_content.toolname, input.obj_content.subjectname ];
                  };
                  input.applicable = function( subjectname, toolname ) {
                     return input.obj_content.subjectname == subjectname 
                            && input.obj_content.toolname == toolname;
                  };
                  input.perform = function( game ) {
                     game.move_between_entities( input.obj_content.toolname, game.inventory, null );
                     pair = game.find( input.obj_content.subjectname );
                     subject = pair[0];
                     entity  = pair[1];
                     if ( subject != null ) {
                        entity.take( subject.obj_content.name );
                        retval = game.find_in_limbo_and_remove( input.obj_content.resultname );
                        entity.put( retval );
                        return retval;
                     }
                     return null;
                  };
                  input.showIt = function( game ) {
                     var vws = game.views;

                     // removing itself
                     var place = -1;
                     for ( var i = 0; i < vws.length; ++i ) {
                        if ( vws[i].obj_content.resultname = input.obj_content.resultname ) {
                           place = i;
                        }
                     }
                     if ( place >= 0 ) {
                        game.views.splice( place, 1 );
                     }
                     return input.perform( game );
                  };
                  input.doIt = function( game ) {
                     var uses = game.use_actions;

                     // removing itself
                     var place = -1;
                     for ( var i = 0; i < uses.length; ++i ) {
                        if ( uses[i].obj_content.resultname == input.obj_content.resultname ) {
                           place = i;
                        }
                     }
                     if ( place >= 0) {
                        game.use_actions.splice( place, 1 );
                     }

                     return input.perform( game );
                  };
                  break;
               case "GamePassageRevealAction" :  
                  input.subject_to_reveal = function() {
                     return [ '@#passage#@'];
                  };
                  input.get_actor_names = function() {
                     if ( input.obj_content.subjectname < input.obj_content.toolname ) {
                        return [ input.obj_content.subjectname, input.obj_content.toolname ];
                     }
                     return [ input.obj_content.toolname, input.obj_content.subjectname ];
                  };
                  input.get_passage_identifier = function () {
                     return input.obj_content.identifier;
                  };
                  input.applicable = function( subjectname, toolname ) {
                     return input.obj_content.subjectname == subjectname 
                            && input.obj_content.toolname == toolname;
                  };
                  input.doIt = function( game ) {
                     for( var i = 0; i < game.passages.length; ++i ) {
                        if ( game.passages[i].obj_content.identifier == input.obj_content.identifier ) {
                           game.passages[i].make_visible();
                        }
                     }
                  };
                  break;
               case "GameObjectRevealAction" :
                  input.subject_to_reveal = function() {
                     return [ input.obj_content.subjectname ];
                  };
                  input.get_actor_names = function() {
                     if ( input.obj_content.subjectname < input.obj_content.toolname ) {
                        return [ input.obj_content.subjectname, input.obj_content.toolname ];
                     }
                     return [ input.obj_content.toolname, input.obj_content.subjectname ];
                  };
                  input.get_passage_identifier = function () {
                     return input.obj_content.identifier;
                  };
                  input.applicable = function( subjectname, toolname ) {
                     return input.obj_content.subjectname == subjectname 
                            && input.obj_content.toolname == toolname;
                  };
                  input.showIt = function( game ) {
                     var vws = game.views;

                     // removing itself
                     var place = -1;
                     for ( var i = 0; i < vws.length; ++i ) {
                        if ( vws[i].obj_content.resultname = input.obj_content.resultname ) {
                           place = i;
                        }
                     }
                     if ( place >= 0 ) {
                        game.views.splice( place, 1 );
                     }

                     var pair2   = game.find( input.obj_content.toolname );
                     var tool    = pair2[0];
                     var pair1   = game.find( input.obj_content.subjectname );
                     var subject = pair1[0];
                     if ( tool != null && subject != null && !subject.is_visible() ) {
                        subject.make_visible();
                        return subject;
                     }
                     return null;
                  };
                  break;
            }
         }

         function GameInternal( params ) {
            var self = this;
            this.rooms        = params[0]; 
            this.limbo        = params[1]; 
            this.room         = this.rooms[0];
            this.passages     = params[2];
            this.inventory    = { obj_content : { attributes: [], childObjects: [], name: "inventory"}, obj_name: "GameObject" }
            addFunctionsToObjectsRecursively( this.inventory );
            this.use_actions  = params[3];
            this.views        = params[4];
            this.won_         = 0;
            this.final_room   = params[5];
            this.descriptions = params[6];
            this.current_room = function () {
               return self.room.obj_content.name;
            };
            this.find_in_limbo_and_remove = function( name ) {
               var retval = null;
               var place = 0;
               for ( var i = 0; i < self.limbo.length; ++i ) {
                  if ( self.limbo[i].obj_content.name == name ) {
                     retval = self.limbo[i];
                     place  = i;
                     break;
                  }
               }
               if ( retval != null ) {
                  self.limbo.splice( place, 1 );
               }
               return retval;
            };
            this.find_room = function( name ) {
               for ( var i = 0; i < self.rooms.length; ++i ) {
                  if ( self.rooms[i].obj_content.name == name ) {
                     return self.rooms[i];
                  }
               }
               return null;
            };
            this.winning = function() {
               self.won_ = 1;
            };
            this.setting_current_room = function( name ) {
               var retval = self.find_room( name );
               if ( retval != null ) {
                  self.room = retval;
                  if ( name == self.final_room ) {
                     self.winning();
                  }
               }
            };
            this.won = function () {
               return this.won_;
            };
            this.move_between_entities = function( name, from_entity, to_entity ) {
               var subject = from_entity.take( name );
               if ( subject != null ) {
                  if ( to_entity != null ) {
                     to_entity.put( subject );
                  }
                  return subject;
               }
               return null;
            };
            this.view_refresh = function () {
               for ( var i = 0; i < self.views.length; ++i ) {
                  var action = self.views[i];
                  var pair1  = self.find( action.obj_content.subjectname );
                  var pair2  = self.find( action.obj_content.toolname );
                  if ( pair1[0] != null && pair2[0] != null && action.applicable( pair1[0].obj_content.name, pair2[0].obj_content.name ) ) {
                     action.showIt( self );
                  }
               }
            };
            this.find_in_entities = function ( name, entities ) {
               for ( var i = 0; i < entities.length; ++i ) {
                  var attempt = entities[i].find( name );
                  if ( attempt != null ) {
                     return [ attempt, entities[i] ];
                  }
               }
               return [null, null];
            };
            this.find_room = function ( name ) {
               for ( var i = 0; i < self.rooms.length; ++i ) {
                  if ( self.rooms[i].obj_content.name == name ) {
                     return self.rooms[i];
                  }
               }
               return null;
            };
            this.open = function ( name, other ) {
               if ( other != '' ) {
                  return 0;
               }
               var pair = self.find( name );
               if ( pair[0] == null ) {
                  return 0;
               }
               if ( pair[0].children().length == 0 ) {
                  return 0;
               }
               while ( pair[0].children().length > 0 ) {
                  pair[1].put(pair[0].take( pair[0].children()[0].obj_content.name ) );
               }
               return 1;
            };
            this.use_internal = function( subjectname, toolname ) {
               if ( subjectname == '' ) {
                  return null;
               }
               var pair1 = self.find( subjectname );
               if ( pair1[0] == null ) {
                  return null;
               }
               if ( toolname == '' ) {
                  for ( var i = 0; i < self.use_actions.length; ++i ) {
                     var action = self.use_actions[i];
                     if ( action.applicable( pair1[0].obj_content.name, '' ) ) {
                        return action.doIt( self );
                     }
                  }
                  return null;
               } else {
                  var tlo = self.inventory.find( toolname );
                  if ( tlo == null ) {
                     return null;
                  }
                  for ( var i = 0; i < self.use_actions.length; ++i ) {
                     var action = self.use_actions[i];
                     if ( action.applicable( pair1[0].obj_content.name, tlo.obj_content.name ) ) {
                        return action.doIt( self );
                     }
                  }
                  return null;
               }
            };
            this.take = function( name, other ) {
               if ( other != '' ) {
                  return 0;
               }
               return self.move_between_entities( name, self.room, self.inventory );
            };
            this.drop = function( name, other ) {
               if ( other != '' ) {
                  return 0;
               }
               return self.move_between_entities( name, self.inventory, self.room );
            };
            this.has = function( name ) {
               var subject = self.inventory.find( name );
               return subject;
            };
            this.look = function() {
               var desc = self.descriptions[self.room.get_hash_name()];
               if ( desc == undefined ) {
                  return '';
               } else {
                  return desc;
               }
            };
            this.find = function( name ) {
               return self.find_in_entities( name, [ self.inventory, self.room ] );
            };
            this.use  = function( subjectname, toolname ) {
               if ( typeof(toolname) === 'undefined' ) {
                  toolname = '';
               }
               var retval = self.use_internal( subjectname, toolname );
               if ( retval != null ) {
                  return retval;
               }
               return self.use_internal( toolname, subjectname );
            };
            this.directionsInternal = function( roomname, visibility ) {
               if ( typeof(visibility) === 'undefined' ) {
                  visibility = 1;
               }
               var retval = [];
               for ( var i = 0; i < self.passages.length; ++i ) {
                  var passage = self.passages[i];
                  var tmp = passage.get_out_passage_from_room(roomname, visibility)
                  if ( tmp != null ) {
                     retval.push( tmp );
                  }
               }
               return retval;
            };
            // find_path_between_rooms - not implementing
            // accessible_room_names   - not implementing
            // can_anything_to_do      - not implementing
            // get_subject_names_and_tool_names - not implementing
            // applicable_uses         - not implementing
            // applicable_views        - not implementing
            this.directions = function() {
               return self.directionsInternal( self.room.obj_content.name );
            };
            this.go = function( direction, other ) {
               if ( other != "" ) {
                  return null;
               }
               var topology = self.directions();
               for ( var i = 0; i < topology.length; ++i ) {
                  var pair = topology[i];
                  if ( pair[0] == direction ) {
                     self.setting_current_room( pair[1] );
                     return self.room;
                  }
               }
               return null;
            };
            this.stuffs = function() {
               var retval = [];
               var chlds = self.room.children();
               for ( var i = 0; i < chlds.length; ++i ) {
                  var subject = chlds[i];
                  if ( subject.obj_content.attributes.indexOf('invisible') < 0 ) {
                     var appearance = self.room.find( subject.obj_content.name );
                     if ( appearance != null ) {
                        retval.push( appearance.obj_content.name );
                     }
                  }
               }
               return retval;
            };
         };

         function Game( params ) {
            var self = this;
            this.game_internal = new GameInternal( params );
            this.commands = { 'use'  : this.game_internal.use,
                              'drop' : this.game_internal.drop,
                              'take' : this.game_internal.take,
                              'go'   : this.game_internal.go,
                              'open' : this.game_internal.open };
            this.current_room = function () { return this.game_internal.current_room(); };
            this.look         = function () { return this.game_internal.look(); };
            this.directions   = function () { return this.game_internal.directions(); };
            this.has          = function ( name ) { return this.game_internal.has( name ); };
            this.stuffs       = function () { return this.game_internal.stuffs(); };
            this.won          = function () { return this.game_internal.won(); };
            this.inventory    = function () { return this.game_internal.inventory.takable_child_names(); };
            this.do_it        = function ( command, arg1, arg2 ) {
               if ( typeof(arg2) === 'undefined' ) {
                  arg2 = '';
               }
               if ( command in this.commands ) {
                  var retval = this.commands[ command ]( arg1, arg2 );
                  self.game_internal.view_refresh();
                  if ( self.won() ) {
                     goEndScreen();
                  }
                  return retval;
               }
               return null;
            };
         };

         var game = null;
         var game_object_xy = null;
         var game_direction_areas = null;

         function initGame() {
            game_object_xy = {"table":[478,241],"candle":[508,205],"match":[582,263],"bird":[537,200],"stone":[532,264],"picture":[0.5,156.5],"dark_room":[0,0],"knife":[314.5,313],"cabinet":[376,195.5],"bathroom":[0,0],"secret_room":[0,0],"burning_candle":[502,203],"injured_bird":[536,199]};
            game_direction_areas = {"dark_room_N":[499,157,31,37],"bathroom_S":[0,354,639,45],"dark_room_W":[25,205,125,96],"secret_room_E":[0,0,50,50]};
            var blueprints = JSON.parse( document.getElementById('blueprints').innerText );
            addFunctionsToObjectsRecursively( blueprints );
            game = new Game( blueprints );
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
         }

         // Smoke tests:
         // ------------

         // GameObject:
         // console.log( blueprints[0][0].find( 'bird' ) );
         // console.log( blueprints[0][0].takable_child_names() );
         // console.log( blueprints[0][0].openable_child_names() );
         // console.log( blueprints[0][0].children() );
         // console.log( blueprints[0][0].descendants( true ) );

         // console.log( blueprints[0][0].takable_child_names() );
         // var mybird = blueprints[0][0].take( 'bird' );
         // console.log( blueprints[0][0].takable_child_names() );
         // blueprints[0][0].put( mybird );
         // console.log( blueprints[0][0].takable_child_names() );

         // GamePassage:
         // console.log( blueprints[2][0].get_ordered_name() );
         // console.log( blueprints[2][1].get_ordered_name() );
         // console.log( blueprints[2][0].get_out_passage_from_room('dark_room') );
         // console.log( blueprints[2][1].get_out_passage_from_room('dark_room') );
         // console.log( blueprints[2][1].get_out_passage_from_room('dark_room',0) );

         // console.log( game_internal.current_room() );
         // console.log( game_internal.find_in_limbo_and_remove('burning_candle') );
         // console.log( game_internal.find_in_limbo_and_remove('turbo killer') );
         // console.log( game_internal.find_room('dark_room') );
         // console.log( game_internal.find_room('purple room') );

         // console.log( game_internal.current_room() );
         // game_internal.setting_current_room('bathroom');
         // console.log( game_internal.current_room() );
         // console.log( game.stuffs() );
         // console.log( game.directions() );
         // game.do_it('take', 'match');
         // game.do_it('take', 'candle');
         // console.log( game.stuffs() );
         // console.log( game.inventory() );

         var placing = 0;

         var inventory_spacing = 60;

         function drawNormalizedItem( names, x, y ) {
            var wi = images[ names ].width;
            var he = images[ names ].height;
            if ( wi > inventory_spacing || he > inventory_spacing ) {
               var scale = Math.min(inventory_spacing / wi, inventory_spacing / he );
               wi = wi * scale;
               he = he * scale;
            }
            context.drawImage(images[ names ], x - wi / 2, y - he / 2, wi, he);
         }

         function drawGameBackground( area ) {
            context.fillStyle = "black";
            context.fillRect(area[0],area[1],area[2],area[3]);
            context.drawImage(images[ game.current_room() ], area[0], area[1], area[2], area[3], area[0], area[1], area[2], area[3]);
         }

         function drawGameObjects() {
            var stfs = game.stuffs();
            for ( var i = 0; i < stfs.length; ++i ) {
               if ( !( stfs[i] in game_object_xy ) ) {
                  game_object_xy[ stfs[i] ] = [0, 0];
               }
               var xy = game_object_xy[ stfs[i] ];
               context.drawImage(images[ stfs[i] ], xy[0], xy[1]);
            }
            var invtr = game.inventory();
            for ( var i = 0; i < invtr.length; ++i ) {
               drawNormalizedItem( invtr[i], i * inventory_spacing + inventory_spacing / 2, 400 + inventory_spacing / 2 );
            }
            var drs = game.directions();
            if ( placing ) {
               for ( var i = 0; i < drs.length; ++i ) {
                  var ident = game.current_room() + '_' + drs[i][0];
                  
                  if ( !( game_direction_areas[ident] ) ) {
                     game_direction_areas[ident] = [0,0,50,50];
                  }
                  var xywh = game_direction_areas[ident];
                  context.fillStyle = "blue";
                  context.fillRect(xywh[0],xywh[1],xywh[2],xywh[3]);
               }
            } else {
               for ( var i = 0; i < drs.length; ++i ) {
                  var ident = game.current_room() + '_' + drs[i][0];
                  if ( !( game_direction_areas[ident] ) ) {
                     game_direction_areas[ident] = [0,0,50,50];
                  }
                  var xywh = game_direction_areas[ident];
                  if ( images[ ident ].width > 0 ) {
                     context.drawImage(images[ ident ], xywh[0] + xywh[2] / 2 - images[ ident ].width / 2, xywh[1] + xywh[3] / 2 - images[ ident ].height / 2);
                  }
               }
            }
         }

         var curX = 0;
         var curY = 0;
         var preX = 0; // previous drawed cursor pos
         var preY = 0;
         var selection = "";
         function drawGameCursor() {
            preX = curX;
            preY = curY;
            if ( selection == "" ) {
               context.drawImage(images["cursor"], 0, 0, 135, 210, curX, curY, cursorWidth, cursorHeight);
            } else {
               drawNormalizedItem( selection, curX, curY );
            }
         }

         var moved = "";
         var areamoved = "";
         var areadir = 0;

         function gameKeyHandler(e) {
           // console.log(e);
           switch( e.keyCode ) {
             case 80:
               redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
               placing = 1 - placing;
               break;
           }
         }

         function gameOnMouseDown(event) {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            if ( areamoved != "" ) {
               areamoved = "";
               console.log( JSON.stringify( game_direction_areas ) );
            }
            
            if ( placing ) {
               var stfs = game.stuffs();
               for ( var i = 0; i < stfs.length; ++i ) {
                  var ident = stfs[i];
                  var xy = game_object_xy[ ident ];
                  if ( event.clientX >= xy[0] && event.clientX < xy[0] + images[ ident ].width
                    && event.clientY >= xy[1] && event.clientY < xy[1] + images[ ident ].height ) {
                     moved = ident;
                  }
               }
               if ( moved == "" ) {
                  var drs = game.directions();
                  for ( var i = 0; i < drs.length; ++i ) {
                     var ident = game.current_room() + '_' + drs[i][0];
                     var xywh = game_direction_areas[ident];
                     if ( event.clientX >= xywh[0] && event.clientX < xywh[0] + xywh[2] 
                       && event.clientY >= xywh[1] && event.clientY < xywh[1] + xywh[3] ) {
                        areamoved = ident;
                        areadir   = 1;
                     }
                  }
               }
            } else {
               var stfs = game.stuffs();
               if ( event.clientY <= gameScreenSeparatorY ) {

                  var drs = game.directions();
                  console.log( drs );
                  if ( selection == "" ) {
                     for ( var i = 0; i < drs.length; ++i ) {
                        var ident = game.current_room() + '_' + drs[i][0];
                        if ( images[ident].width > 0 ) {
                           var xywh = game_direction_areas[ident];
                           if ( event.clientX >= xywh[0] && event.clientX < xywh[0] + xywh[2] 
                             && event.clientY >= xywh[1] && event.clientY < xywh[1] + xywh[3] ) {
                              game.do_it( 'go', drs[i][0] );
                              return ;
                           }
                        }
                     }
                  }

                  var something = 0;
                  for ( var i = 0; i < stfs.length; ++i ) {
                     var ident = stfs[i];
                     var xy = game_object_xy[ ident ];
                     if ( event.clientX >= xy[0] && event.clientX < xy[0] + images[ ident ].width
                       && event.clientY >= xy[1] && event.clientY < xy[1] + images[ ident ].height ) {
                        something = 1;
                        if ( selection == "" ) {
                           if ( game.do_it( 'open', ident ) || game.do_it( 'use', ident ) != null || game.do_it( 'take', ident ) ) {
                              break;
                           }
                        } else {
                           var xy = game_object_xy[ ident ];
                           var res = game.do_it( 'use', ident, selection );
                           if ( res != null ) {
                              var tarid = res.obj_content.name;
                              game_object_xy[ tarid ] = xy;
                              break;
                           }
                        }
                     }
                  }
                  if ( selection != "" && !something ) {
                     game.do_it( 'drop', selection );
                     game_object_xy[ selection ] = [ Math.floor( Math.random() * 320 ) + 160, 300 + Math.floor( Math.random() * 30 ) ];
                  }
                  if ( !something ) {
                     var drs = game.directions();
                     if ( selection == "" ) {
                        for ( var i = 0; i < drs.length; ++i ) {
                           var ident = game.current_room() + '_' + drs[i][0];
                           var xywh = game_direction_areas[ident];
                           if ( event.clientX >= xywh[0] && event.clientX < xywh[0] + xywh[2] 
                             && event.clientY >= xywh[1] && event.clientY < xywh[1] + xywh[3] ) {
                              game.do_it( 'go', drs[i][0] );
                              return ;
                           }
                        }
                     }
                  }
               } else {
                  if ( event.clientY <= gameScreenSeparatorY + inventory_spacing ) {
                     var cell = Math.floor( event.clientX / inventory_spacing );
                     var invtr = game.inventory();
                     if ( cell < invtr.length ) {
                        if ( selection != "" ) {
                           game.do_it( 'use', invtr[cell], selection );
                        } else {
                           selection = invtr[cell];
                           return;
                        }
                     }
                  }
               }
               selection = "";
            }
         };

         function gameOnMouseUp(event) {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            if ( placing ) {
               if ( moved != "" ) {
                  console.log( JSON.stringify( game_object_xy ) );
               }
               moved = "";
               if ( areamoved != "" ) {
                  areadir = 0;
               }
            }
         };

         function gameOnMouseMove(event) {
            curX = event.clientX;
            curY = event.clientY;

            // redrawArea = [0, 0, gameScreenWidth, gameScreenHeight ];
            // redrawArea = [0,0,10,10];
            redrawArea = [Math.max( preX - inventory_spacing / 2 - 5, 0),
                          Math.max( preY - inventory_spacing / 2 - 5, 0),
                          preX + inventory_spacing / 2 + 5,
                          preY + inventory_spacing / 2 + 5];

            if ( placing && moved != "" ) {
               game_object_xy[ moved ] = [ curX - images[ moved ].width / 2, curY - images[ moved ].height / 2 ];
            }
            if ( placing && areamoved != "" ) {
               if ( areadir ) {
                  game_direction_areas[areamoved] = [ curX, curY, game_direction_areas[areamoved][2], game_direction_areas[areamoved][3] ];
               } else {
                  game_direction_areas[areamoved] = [ game_direction_areas[areamoved][0], game_direction_areas[areamoved][1], curX - game_direction_areas[areamoved][0], curY - game_direction_areas[areamoved][1] ];
               }
            }
         };

         function gameSceneDrawer() {
            if ( redrawArea != null ) { 
               drawGameBackground( redrawArea );
               drawGameObjects();
               drawGameCursor();
               redrawArea = null;
            }
         }

         // === Start screen related codes

         function startScreenDrawCursor() {
            preX = curX;
            preY = curY;
            context.drawImage(images["cursor"], 0, 0, 135, 210, curX, curY, cursorWidth, cursorHeight);
         }

         function startScreenDrawer() {
            if ( redrawArea != null ) { 
               var area = redrawArea;
               context.fillStyle = "black";
               context.fillRect(area[0],area[1],area[2],area[3]);
               context.drawImage(images[ 'menuitem_screen1' ], area[0], area[1], area[2], area[3], area[0], area[1], area[2], area[3]);
               context.drawImage(images[ 'menuitem_button1' ], 230, 250);
               startScreenDrawCursor();
               redrawArea = null;
            }
         }

         function startScreenInit() {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
         }

         function startScreenOnMouseMove(event) {
            curX = event.clientX;
            curY = event.clientY;

            // redrawArea = [0, 0, gameScreenWidth, gameScreenHeight ];
            // redrawArea = [0,0,10,10];
            redrawArea = [Math.max( preX - inventory_spacing / 2 - 5, 0),
                          Math.max( preY - inventory_spacing / 2 - 5, 0),
                          preX + inventory_spacing / 2 + 5,
                          preY + inventory_spacing / 2 + 5];
         }

         function startScreenOnMouseDown(event) {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            curX = event.clientX;
            curY = event.clientY;
            if ( curX > 230
                 && curY > 250
                 && curX < 230 +  images[ 'menuitem_button1' ].width 
                 && curY < 250 +  images[ 'menuitem_button1' ].height ) {
               goGame();
            }
         }

         function goGame() {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            initGame();
            mainItem.scenedrawer = gameSceneDrawer;
            mainItem.onmousedown = gameOnMouseDown;
            mainItem.onmouseup   = gameOnMouseUp;
            mainItem.onmousemove = gameOnMouseMove;
         }
         
         function goInitScreen() {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            startScreenInit();
            mainItem.scenedrawer = startScreenDrawer;
            mainItem.onmousemove = startScreenOnMouseMove;
            mainItem.onmousedown = startScreenOnMouseDown;
         }

         function goEndScreen() {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            endScreenInit();
            mainItem.scenedrawer = endScreenDrawer;
            mainItem.onmousemove = endScreenOnMouseMove;
            mainItem.onmousedown = endScreenOnMouseDown;
         }

         // === End screen related codes

         function endScreenDrawCursor() {
            preX = curX;
            preY = curY;
            context.drawImage(images["cursor"], 0, 0, 135, 210, curX, curY, cursorWidth, cursorHeight);
         }

         function endScreenDrawer() {
            if ( redrawArea != null ) { 
               var area = redrawArea;
               context.fillStyle = "black";
               context.fillRect(area[0],area[1],area[2],area[3]);
               context.drawImage(images[ 'menuitem_screen2' ], area[0], area[1], area[2], area[3], area[0], area[1], area[2], area[3]);
               context.drawImage(images[ 'menuitem_button2' ], 230, 250);
               endScreenDrawCursor();
               redrawArea = null;
            }
         }

         function endScreenInit() {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
         }

         function endScreenOnMouseMove(event) {
            curX = event.clientX;
            curY = event.clientY;

            // redrawArea = [0, 0, gameScreenWidth, gameScreenHeight ];
            // redrawArea = [0,0,10,10];
            redrawArea = [Math.max( preX - inventory_spacing / 2 - 5, 0),
                          Math.max( preY - inventory_spacing / 2 - 5, 0),
                          preX + inventory_spacing / 2 + 5,
                          preY + inventory_spacing / 2 + 5];
         }

         function endScreenOnMouseDown(event) {
            redrawArea = [0, 0, gameScreenWidth, gameScreenHeight];
            curX = event.clientX;
            curY = event.clientY;
            if ( curX > 230
                 && curY > 250
                 && curX < 230 +  images[ 'menuitem_button2' ].width 
                 && curY < 250 +  images[ 'menuitem_button2' ].height ) {
               goInitScreen();
            }
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               try {
                  mainItem.scenedrawer();
               } catch(err) {
               }
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
            if ( devMode ) {
               addEventListener('keydown',gameKeyHandler,false);
            }

            goInitScreen();
         })();
      </script>
   </body>
</html>
